<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-shopping-cart"></i> Order Management</h1>
        <p>View and manage all orders.</p>
    </div>

    <div class="admin-section">
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Plan</th>
                        <th>Original Price</th>
                        <th>Discount</th>
                        <th>Final Price</th>
                        <th>Coupon</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (orders.length === 0) { %>
                        <tr>
                            <td colspan="10" class="no-data">No orders found</td>
                        </tr>
                    <% } else { %>
                        <% orders.forEach(order => { %>
                            <tr>
                                <td>#<%= order.id %></td>
                                <td><%= order.first_name %> <%= order.last_name %><br><small><%= order.email %></small></td>
                                <td><%= order.plan_name || 'Custom' %></td>
                                <td>$<%= parseFloat(order.original_price || order.price).toFixed(2) %></td>
                                <td>
                                    <% if (order.discount_amount && parseFloat(order.discount_amount) > 0) { %>
                                        -$<%= parseFloat(order.discount_amount).toFixed(2) %>
                                    <% } else { %>
                                        -
                                    <% } %>
                                </td>
                                <td>$<%= parseFloat(order.price).toFixed(2) %></td>
                                <td>
                                    <% if (order.coupon_code) { %>
                                        <span class="status-badge active"><%= order.coupon_code %></span>
                                    <% } else { %>
                                        -
                                    <% } %>
                                </td>
                                <td>
                                    <select class="form-control status-select" data-order-id="<%= order.id %>" style="padding: 0.25rem; font-size: 0.9rem;">
                                        <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                                        <option value="paid" <%= order.status === 'paid' ? 'selected' : '' %>>Paid</option>
                                        <option value="failed" <%= order.status === 'failed' ? 'selected' : '' %>>Failed</option>
                                        <option value="refunded" <%= order.status === 'refunded' ? 'selected' : '' %>>Refunded</option>
                                        <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                                    </select>
                                </td>
                                <td><%= new Date(order.created_at).toLocaleDateString() %></td>
                                <td>
                                    <small>CPU: <%= order.cpu %>, RAM: <%= order.ram %>MB</small>
                                </td>
                            </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <% if (totalPages > 1) { %>
            <div class="pagination">
                <% if (currentPage > 1) { %>
                    <a href="/admin/orders?page=<%= currentPage - 1 %>" class="page-btn">Previous</a>
                <% } else { %>
                    <span class="page-btn disabled">Previous</span>
                <% } %>
                
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <a href="/admin/orders?page=<%= i %>" class="page-btn <%= i === currentPage ? 'active' : '' %>"><%= i %></a>
                <% } %>
                
                <% if (currentPage < totalPages) { %>
                    <a href="/admin/orders?page=<%= currentPage + 1 %>" class="page-btn">Next</a>
                <% } else { %>
                    <span class="page-btn disabled">Next</span>
                <% } %>
            </div>
        <% } %>
    </div>
</div>

<link rel="stylesheet" href="/css/admin.css">
<script>
// Handle status changes
document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', async function() {
        const orderId = this.dataset.orderId;
        const status = this.value;
        
        try {
            const response = await fetch(`/admin/orders/${orderId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            
            const data = await response.json();
            if (data.success) {
                alert('Order status updated successfully');
            } else {
                alert('Error updating status: ' + data.error);
                location.reload();
            }
        } catch (err) {
            alert('Error updating status: ' + err.message);
            location.reload();
        }
    });
});
</script>
