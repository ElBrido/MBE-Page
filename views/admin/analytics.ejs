<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-chart-bar"></i> Analytics & Reports</h1>
        <p>View platform performance metrics and insights.</p>
    </div>

    <!-- Revenue by Month -->
    <div class="admin-section">
        <h2><i class="fas fa-dollar-sign"></i> Revenue by Month</h2>
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Orders</th>
                        <th>Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (revenueByMonth.length === 0) { %>
                        <tr>
                            <td colspan="3" class="no-data">No revenue data available</td>
                        </tr>
                    <% } else { %>
                        <% revenueByMonth.forEach(row => { %>
                            <tr>
                                <td><%= new Date(row.month).toLocaleDateString('en-US', { year: 'numeric', month: 'long' }) %></td>
                                <td><%= row.order_count %></td>
                                <td><strong>$<%= parseFloat(row.revenue).toFixed(2) %></strong></td>
                            </tr>
                        <% }) %>
                        <% 
                        const totalRevenue = revenueByMonth.reduce((sum, row) => sum + parseFloat(row.revenue), 0);
                        const totalOrders = revenueByMonth.reduce((sum, row) => sum + parseInt(row.order_count), 0);
                        %>
                        <tr style="background: var(--bg-light); font-weight: bold;">
                            <td>TOTAL</td>
                            <td><%= totalOrders %></td>
                            <td>$<%= totalRevenue.toFixed(2) %></td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Popular Plans -->
    <div class="admin-section" style="margin-top: 2rem;">
        <h2><i class="fas fa-box"></i> Popular Plans</h2>
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Plan Name</th>
                        <th>Total Orders</th>
                        <th>Total Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (popularPlans.length === 0) { %>
                        <tr>
                            <td colspan="3" class="no-data">No plan data available</td>
                        </tr>
                    <% } else { %>
                        <% popularPlans.forEach(plan => { %>
                            <tr>
                                <td><strong><%= plan.name %></strong></td>
                                <td><%= plan.order_count || 0 %></td>
                                <td>$<%= parseFloat(plan.revenue || 0).toFixed(2) %></td>
                            </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Coupon Usage Statistics -->
    <div class="admin-section" style="margin-top: 2rem;">
        <h2><i class="fas fa-tag"></i> Coupon Usage Statistics</h2>
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Coupon Code</th>
                        <th>Times Used</th>
                        <th>Total Discount Given</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (couponStats.length === 0) { %>
                        <tr>
                            <td colspan="3" class="no-data">No coupon usage data available</td>
                        </tr>
                    <% } else { %>
                        <% couponStats.forEach(stat => { %>
                            <tr>
                                <td><strong><%= stat.code %></strong></td>
                                <td><%= stat.usage_count || 0 %></td>
                                <td>$<%= parseFloat(stat.total_discount || 0).toFixed(2) %></td>
                            </tr>
                        <% }) %>
                        <% 
                        const totalDiscountGiven = couponStats.reduce((sum, stat) => sum + parseFloat(stat.total_discount || 0), 0);
                        const totalCouponUses = couponStats.reduce((sum, stat) => sum + parseInt(stat.usage_count || 0), 0);
                        %>
                        <tr style="background: var(--bg-light); font-weight: bold;">
                            <td>TOTAL</td>
                            <td><%= totalCouponUses %></td>
                            <td>$<%= totalDiscountGiven.toFixed(2) %></td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Key Metrics -->
    <div style="margin-top: 2rem;">
        <h2><i class="fas fa-chart-line"></i> Key Metrics</h2>
        <div class="stats-grid">
            <% if (revenueByMonth.length > 0) { %>
                <div class="stat-card">
                    <div class="stat-icon revenue">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3>$<%= revenueByMonth.reduce((sum, row) => sum + parseFloat(row.revenue), 0).toFixed(2) %></h3>
                        <p>Total Revenue (Last 12 Months)</p>
                    </div>
                </div>
            <% } %>

            <% if (revenueByMonth.length > 1) { %>
                <%
                const currentMonth = revenueByMonth[0];
                const previousMonth = revenueByMonth[1];
                const avgOrderValue = parseFloat(currentMonth.revenue) / parseInt(currentMonth.order_count);
                %>
                <div class="stat-card">
                    <div class="stat-icon orders">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-info">
                        <h3>$<%= avgOrderValue.toFixed(2) %></h3>
                        <p>Average Order Value (Current Month)</p>
                    </div>
                </div>
            <% } %>

            <% if (couponStats.length > 0) { %>
                <%
                const totalDiscount = couponStats.reduce((sum, stat) => sum + parseFloat(stat.total_discount || 0), 0);
                %>
                <div class="stat-card">
                    <div class="stat-icon coupons">
                        <i class="fas fa-tag"></i>
                    </div>
                    <div class="stat-info">
                        <h3>$<%= totalDiscount.toFixed(2) %></h3>
                        <p>Total Discounts Given</p>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<link rel="stylesheet" href="/css/admin.css">
