<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-users"></i> User Management</h1>
        <p>Manage user accounts, roles, and permissions.</p>
    </div>

    <div class="admin-section">
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Servers</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (users.length === 0) { %>
                        <tr>
                            <td colspan="8" class="no-data">No users found</td>
                        </tr>
                    <% } else { %>
                        <% users.forEach(u => { %>
                            <tr>
                                <td>#<%= u.id %></td>
                                <td><%= u.first_name %> <%= u.last_name %></td>
                                <td><%= u.email %></td>
                                <td>
                                    <select class="form-control role-select" data-user-id="<%= u.id %>" style="padding: 0.25rem; font-size: 0.9rem;">
                                        <option value="user" <%= u.role === 'user' ? 'selected' : '' %>>User</option>
                                        <option value="admin" <%= u.role === 'admin' ? 'selected' : '' %>>Admin</option>
                                    </select>
                                </td>
                                <td><%= u.server_count %></td>
                                <td>
                                    <% if (u.is_active) { %>
                                        <span class="status-badge active">Active</span>
                                    <% } else { %>
                                        <span class="status-badge inactive">Inactive</span>
                                    <% } %>
                                </td>
                                <td><%= new Date(u.created_at).toLocaleDateString() %></td>
                                <td>
                                    <button class="btn-admin btn-admin-secondary toggle-active-btn" data-user-id="<%= u.id %>" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                        <% if (u.is_active) { %>
                                            Deactivate
                                        <% } else { %>
                                            Activate
                                        <% } %>
                                    </button>
                                </td>
                            </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <% if (totalPages > 1) { %>
            <div class="pagination">
                <% if (currentPage > 1) { %>
                    <a href="/admin/users?page=<%= currentPage - 1 %>" class="page-btn">Previous</a>
                <% } else { %>
                    <span class="page-btn disabled">Previous</span>
                <% } %>
                
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <a href="/admin/users?page=<%= i %>" class="page-btn <%= i === currentPage ? 'active' : '' %>"><%= i %></a>
                <% } %>
                
                <% if (currentPage < totalPages) { %>
                    <a href="/admin/users?page=<%= currentPage + 1 %>" class="page-btn">Next</a>
                <% } else { %>
                    <span class="page-btn disabled">Next</span>
                <% } %>
            </div>
        <% } %>
    </div>
</div>

<link rel="stylesheet" href="/css/admin.css">
<script>
// Handle role changes
document.querySelectorAll('.role-select').forEach(select => {
    select.addEventListener('change', async function() {
        const userId = this.dataset.userId;
        const role = this.value;
        
        try {
            const response = await fetch(`/admin/users/${userId}/role`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role })
            });
            
            const data = await response.json();
            if (data.success) {
                alert('Role updated successfully');
            } else {
                alert('Error updating role: ' + data.error);
                location.reload();
            }
        } catch (err) {
            alert('Error updating role: ' + err.message);
            location.reload();
        }
    });
});

// Handle toggle active
document.querySelectorAll('.toggle-active-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const userId = this.dataset.userId;
        
        if (!confirm('Are you sure you want to toggle this user\'s active status?')) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/users/${userId}/toggle-active`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Error toggling status: ' + data.error);
            }
        } catch (err) {
            alert('Error toggling status: ' + err.message);
        }
    });
});
</script>
